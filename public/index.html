<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>TubeKara - YouTube Karaoke Made Easy</title>
  <meta name="description" content="YouTube Karaoke Made Easy">
  <meta name="author" content="An Pham">
  <script src="//code.jquery.com/jquery-2.1.3.min.js"></script> 
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.8/angular.min.js"></script>
  <script src="app.js"></script>
  <script src="controllers/controllers.js"></script>
  <script src="configs/routes.js"></script>  
  <link rel="stylesheet" type="text/css" href="assets/stylesheets/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="assets/stylesheets/style.css">
</head>

<body ng-app="TubeKara">
  <p id="welcome-text" ng-controller="MainCtrl">{{ welcome }}</p>
  <div id="search-form" ng-controller="MainCtrl">
    <input ng-model="startSong" type="text" id="startSongInput" autocomplete="off" placeholder="Please enter your song">
    <ul id="startSongInputSuggestion"></ul>
  </div>
  <div id="main-wrapper" ng-controller="MainCtrl">
    <iframe id="player-frame" class="hidden" frameborder="0" allowfullscreen="1" title="YouTube video player"></iframe>
    <div id="user-control" class="hidden">
      <div id="control-wrapper">
        <div id="control-title">Play List</div>       
        <input ng-model="newSongInput" type="text" id="newSongInput" placeholder="Please add your next song">
        <i class="btn fa fa-plus fa-2x" id="add-song-btn"></i>
        <ul id="newSongInputSuggestion" class="user-list"></ul> 
        <ul id="play-list" class="user-list"></ul>      
      </div>
    </div>
  </div>
  <footer id="footer">
    <p>Developed by <a target="_blank" href="http://www.apresume.com">An Pham</a>. All rights reserved.</p>
  </footer>
  <script>
    (function() {
      var USER_CONTROL_WIDTH_EXPANDED = "30%";
      var USER_CONTROL_WIDTH_COLLAPSED = "1%";
      var PLAYLIST_DIV = "play-list";
      var PLAYLIST_SGTION_DIV = "newSongInputSuggestion";

      var playlist = [];

      $("#startSongInput").focus();
      
      $("#user-control").mouseenter(function() {
        $("#user-control").css("width", USER_CONTROL_WIDTH_EXPANDED);
        $("#control-wrapper").removeClass("hidden");
      });
      
      $("#user-control").mouseleave(function() {
        $("#user-control").css("width", USER_CONTROL_WIDTH_COLLAPSED);
        $("#control-wrapper").addClass("hidden");
      });

      $("#startSongInput").keyup(function(event) {
        var id = $(this).attr("id");
        var key = (event.keyCode ? event.keyCode : event.which);

        if ([13, 38, 40].indexOf(key) != -1) {
          handleKeyInput(key, "startSongInputSuggestion", "suggestion-item", "selected");
          return;
        }

        var searchInput = $(this).val();
        updateSuggestion(searchInput, 7, "startSongInputSuggestion");
      });

      $("#newSongInput").keyup(function(event) {
        var id = $(this).attr("id");
        var key = (event.keyCode ? event.keyCode : event.which);

        if ([38, 40].indexOf(key) != -1) {
          handleKeyInput(key, "newSongInputSuggestion", "suggestion-item", "selected");
          return;
        }

        if (key == 13) {
          var selectedSong = {};
          if ($("#newSongInputSuggestion li.selected").length != 0) {
            selectedSong = $("#newSongInputSuggestion li.selected").first();
          }
          else {
            selectedSong = $("#newSongInputSuggestion li.suggestion-item").first();
          }
          addSong2Playlist(selectedSong.data('id'), selectedSong.data('title'));
          return;
        }

        var searchInput = $(this).val();
        if (searchInput.length > 1) {
          $("#newSongInputSuggestion").removeClass("hidden");
          $("#playlist").addClass("hidden");
        }
        updateSuggestion(searchInput, 7, "newSongInputSuggestion");
      });

      function handleKeyInput(key, suggestionDiv, suggestionItemClass, selectedClass) {      
        var suggestionDiv = suggestionDiv.indexOf('#') == 0 ? suggestionDiv : ('#'+suggestionDiv);
        var selectedClass = selectedClass.indexOf('.') == 0 ? selectedClass : ('.'+selectedClass);
        var suggestionItemClass = suggestionItemClass.indexOf('.') == 0 ? suggestionItemClass : ('.'+suggestionItemClass);
        var current = $(suggestionDiv+" "+suggestionItemClass).index($(selectedClass));
        var items = $(suggestionDiv+" "+suggestionItemClass);
        var selectedItems = $(suggestionDiv+" "+selectedClass);

        if (key == 13) {
          if (selectedItems.length != 0) {
            updateVideoID(selectedItems.first().data('id'));
            addSong2Playlist(selectedItems.first().data('id'), selectedItems.first().data('title'));
          }
          else {
            updateVideoID(items.first().data('id'));
            addSong2Playlist(items.data('id').first(), items.first().data('title'));
          }
          openPlayingPage();
          return;
        }

        if (key == 40) {
          if (current < $(suggestionDiv+" "+suggestionItemClass).length - 1) {
            $(suggestionDiv+" "+suggestionItemClass).eq(current+1).addClass(selectedClass.substring(1));
            $(suggestionDiv+" "+suggestionItemClass).eq(current).removeClass(selectedClass.substring(1));
          }
          return;
        }

        if (key == 38) {
          if (current > 0) {
            $(suggestionDiv+" "+suggestionItemClass).eq(current).removeClass(selectedClass.substring(1));
            $(suggestionDiv+" "+suggestionItemClass).eq(current-1).addClass(selectedClass.substring(1));
          }
          return;
        }

      }

      function updateSuggestion(searchInput, maxResult, suggestionDiv) {
        var keyword= encodeURIComponent(searchInput);
        var ytURL='//gdata.youtube.com/feeds/api/videos?q='+keyword+'&max-results='+maxResult+'&v=2&alt=jsonc';
        var suggestionDiv = suggestionDiv.indexOf('#') == 0 ? suggestionDiv : ('#'+suggestionDiv);

        $.ajax
        ({
          type: "GET",
          url: ytURL,
          dataType:"jsonp",
          success: function(response)
          {
            $(suggestionDiv).empty();
            if(response.data.items)
            {
              $.each(response.data.items, function(i, obj) {
                $(suggestionDiv).append(
                  "<li data-id='"+obj.id+"' "+"data-title='"+obj.title+"'"+" class='suggestion-item'>"+
                    "<img class='suggestion-img' src='"+getImgFromID(obj.id)+"'>"+
                    "<span class='suggestion-title'>"+obj.title+"</span>"+
                  "</li><br />"
                  );
              });

              $(".suggestion-item").first().addClass("selected");
              $(".suggestion-item").hover(function() {
                $(this).addClass("selected");
              }, function() {
                $(this).removeClass("selected")
              });
              $("#startSongInputSuggestion li.suggestion-item").click(function() {
                addSong2Playlist($(this).data('id'), $(this).data('title'));
                playVideo($(this).data('id'));
                openPlayingPage();
              });
              $("#newSongInputSuggestion li.suggestion-item").click(function() {
                addSong2Playlist($(this).data('id'), $(this).data('title'));
              });
            }
            else
            {
              $(suggestionDiv).append("<li>No match found.</li>");
            }
          }
        });

      }

      function updateVideoID(id) {
        $("#player-frame").attr("src", "//www.youtube.com/embed/"+
            id+
            "?enablejsapi=1&origin=https%3A%2F%2Ftubekara.herokuapp.com");
      }

      function addSong2Playlist(id, title) {
        var img = getImgFromID(id);
        playlist.push({ 'id': id, 'img': img, 'title': title});
        updatePlaylistView();
        console.log(playlist);
      }

      function updatePlaylistView() {
        var plDiv = ('#'+PLAYLIST_DIV);
        var sgDiv = ('#'+PLAYLIST_SGTION_DIV);

        $(sgDiv).addClass("hidden");
        $("#newSongInput").val("");
        $("#newSongInputSuggestion").empty();

        $(plDiv).empty();
        $.each(playlist, function(i, obj) {
          $(plDiv).append(
            "<li data-id='"+obj.id+"' "+"data-title='"+obj.title+"'"+" class='playlist-item'>"+
              "<img class='playlist-item-img' src='"+obj.img+"'>"+
              "<span class='playlist-item-title'>"+obj.title+"</span>"+
            "</li><br />"
            );
        });

        $(".playlist-item").click(function() {
          playVideo($(this).data('id'));
        })
        $(".playlist-item").hover(function() {
          $(this).addClass("selected");
        }, function() {
          $(this).removeClass("selected")
        });
      }

      function playVideo(id) {
        updateVideoID(id);
        $("#player-frame")[0].src += "&autoplay=1";
      }

      function getImgFromID(id) {
        return "//img.youtube.com/vi/"+id+"/1.jpg";
      }

      function openPlayingPage() {
        height = $("html").height()*0.85;
        $("html").css('background-image', 'none');
        $("#search-form").remove();
        $("#player-frame").removeClass("hidden");
        $("#player-frame").css("height", height);
        $("#user-control").removeClass("hidden");
        $("#user-control").css("height", height);
        $("body").addClass("stripesDarkBackground");
        $("#newSongInput").focus();
        setTimeout(function() {
          $("#user-control").trigger("mouseleave");
        }, 1000);
        $("#add-song-btn").click(function() {
          var selectedSong = {};
          if ($("#newSongInputSuggestion li.selected").length != 0) {
            selectedSong = $("#newSongInputSuggestion li.selected").first();
          }
          else {
            selectedSong = $("#newSongInputSuggestion li.suggestion-item").first();
          }
          addSong2Playlist(selectedSong.data('id'), selectedSong.data('title'));
        });
        // $("#player-frame")[0].src += "&autoplay=1";
      }
    })();
  </script>
</body>
</html>