<!doctype html>

<html lang="en" ng-app="TubeKara">
<head>
  <meta charset="utf-8">

  <title>TubeKara - YouTube Karaoke Made Easy</title>
  <meta name="description" content="YouTube Karaoke Made Easy">
  <meta name="author" content="An Pham">
  <script src="//code.jquery.com/jquery-2.1.3.min.js"></script> 
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.8/angular.min.js"></script>
  <script src="app.js"></script>
  <script src="controllers/controllers.js"></script>
  <script src="configs/routes.js"></script>  
  <link rel="stylesheet" type="text/css" href="assets/stylesheets/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="assets/stylesheets/style.css">
</head>

<body ng-controller="MainCtrl">
  <p id="welcome-text">{{ welcome }}</p>
  <div id="search-form">
    <input ng-model="startSong" type="text" id="startSongInput" autocomplete="off" placeholder="Please enter your song">
    <ul id="startSongInputSuggestion"></ul>
  </div>
  <div id="main-wrapper">
    <iframe id="player-frame" class="transparent" frameborder="0" title="YouTube video player" type="text/html" src="//www.youtube.com/embed/u1zgFlCw8Aw?enablejsapi=1" allowfullscreen="true"></iframe>
    <div id="user-control" class="hidden">
      <div id="control-wrapper">
        <div id="control-title">Play List</div>       
        <input ng-model="newSongInput" type="text" id="newSongInput" placeholder="Please add your next song">
        <i class="btn fa fa-plus fa-2x add-btn" id="add-song-btn" title="Click to add song."></i>
        <ul id="newSongInputSuggestion" class="user-list hidden"></ul>
        <ul id="playlist" class="user-list">
          <li data-id="{{ item.id }}" data-index="{{ $index }}" class='playlist-item' ng-repeat="item in playlist">
            <i class="btn fa fa-minus fa-2x remove-song-btn hidden" ng-click="removeSong($index)" title="Click to remove song."></i>
            <img class='playlist-item-img' src=" {{ item.img }} ">
            <span class='playlist-item-info'>
              <div class='playlist-item-title'> {{ item.title }} </div>
              <span class='playlist-item-uploader'> {{ item.uploader }} &nbsp;&nbsp;&nbsp;</span>
              <span class='playlist-item-view'> {{ item.view }} views</span>
            </span>
          </li>
        </ul>      
      </div>
    </div>
  </div>
  <footer id="footer">
    <p>Developed by <a target="_blank" href="http://www.apresume.com">An Pham</a>. All rights reserved.</p>
  </footer>
  <script>
    var player; 

    $("#startSongInput").focus();
    
    $("#user-control").mouseenter(function() {
      showUserControl();
    });
    
    $("#user-control").mouseleave(function() {
      hideUserControl();
    });

    (function() {
      var s = document.createElement("script");
      s.src = (location.protocol == 'https:' ? 'https' : 'http') + "://www.youtube.com/player_api";
      var before = document.getElementsByTagName("script")[0];
      before.parentNode.insertBefore(s, before);
    })();

    function showUserControl() {      
      $("#user-control").css("width", "30%");
      $("#control-wrapper").removeClass("hidden");
    }

    function hideUserControl() {      
      $("#user-control").css("width", "1%");
      $("#control-wrapper").addClass("hidden");
    }

    function getImgFromID(id) {
      return "//img.youtube.com/vi/"+id+"/1.jpg";
    }

    $("#startSongInput").keyup(function(event) {
      var id = $(this).attr("id");
      var key = (event.keyCode ? event.keyCode : event.which);
      var items = $("#startSongInputSuggestion .suggestion-item");
      var selectedItems = $("#startSongInputSuggestion .selected");

      if ([38, 40].indexOf(key) != -1) {
        handleKeyInput(key, "startSongInputSuggestion", "suggestion-item", "selected");
        return;
      }

      if (key == 13) {
        selectedSong = getSelectedItem("startSongInputSuggestion", "suggestion-item", "selected");
        openPlayingPage(selectedSong);
        return;
      }

      var searchInput = $(this).val();
      updateSuggestion(searchInput, 7, "startSongInputSuggestion");
    });

    function getSelectedItem(ulDiv, liDiv, selectedClass) {
      var items = $("#"+ulDiv+" ."+liDiv);
      var selectedItems = $("#"+ulDiv+" ."+selectedClass);
      if (selectedItems.length != 0) {
        return selectedItems.first();
      }
      return items.first();
    }

    $("#newSongInput").keyup(function(event) {
      var id = $(this).attr("id");
      var key = (event.keyCode ? event.keyCode : event.which);

      if ([38, 40].indexOf(key) != -1) {
        handleKeyInput(key, "newSongInputSuggestion", "suggestion-item", "selected");
        return;
      }

      if (key == 13) {        
        selectedSong = getSelectedItem("newSongInputSuggestion", "suggestion-item", "selected");
        addSong2Playlist(selectedSong);
        return;
      }

      if (key == 27) {
        $("#newSongInput").val("");
        hideUserControl();
      }

      var searchInput = $(this).val();
      if (searchInput.length >= 1) {
        if ($("#newSongInputSuggestion").hasClass("hidden")) {
          $("#newSongInputSuggestion").removeClass("hidden");
          $("#playlist").addClass("hidden");
        }
        updateSuggestion(searchInput, 7, "newSongInputSuggestion");
      }
      else {
        $("#newSongInputSuggestion").addClass("hidden");
        $("#playlist").removeClass("hidden");
      }
    });

    function handleKeyInput(key, suggestionDiv, suggestionItemClass, selectedClass) {      
      var suggestionDiv = suggestionDiv.indexOf('#') == 0 ? suggestionDiv : ('#'+suggestionDiv);
      var selectedClass = selectedClass.indexOf('.') == 0 ? selectedClass : ('.'+selectedClass);
      var suggestionItemClass = suggestionItemClass.indexOf('.') == 0 ? suggestionItemClass : ('.'+suggestionItemClass);
      var current = $(suggestionDiv+" "+suggestionItemClass).index($(selectedClass));
      var items = $(suggestionDiv+" "+suggestionItemClass);
      var selectedItems = $(suggestionDiv+" "+selectedClass);

      if (key == 40) {
        if (current < $(suggestionDiv+" "+suggestionItemClass).length - 1) {
          $(suggestionDiv+" "+suggestionItemClass).eq(current+1).addClass(selectedClass.substring(1));
          $(suggestionDiv+" "+suggestionItemClass).eq(current).removeClass(selectedClass.substring(1));
        }
        return;
      }

      if (key == 38) {
        if (current > 0) {
          $(suggestionDiv+" "+suggestionItemClass).eq(current).removeClass(selectedClass.substring(1));
          $(suggestionDiv+" "+suggestionItemClass).eq(current-1).addClass(selectedClass.substring(1));
        }
        return;
      }

    }

    function updateSuggestion(searchInput, maxResult, suggestionDiv) {
      var keyword= encodeURIComponent(searchInput);
      var ytURL='//gdata.youtube.com/feeds/api/videos?q='+keyword+'&max-results='+maxResult+'&v=2&alt=jsonc';
      var suggestionDiv = suggestionDiv.indexOf('#') == 0 ? suggestionDiv : ('#'+suggestionDiv);

      $.ajax
      ({
        type: "GET",
        url: ytURL,
        dataType:"jsonp",
        success: function(response)
        {
          $(suggestionDiv).empty();
          if(response.data.items)
          {
            $.each(response.data.items, function(i, obj) {
              $(suggestionDiv).append(
                "<li data-id='"+obj.id+"' "+
                  "data-title='"+escapeQuotes(obj.title)+"' "+
                  "data-uploader='"+obj.uploader+"' "+
                  "data-view='"+obj.viewCount+"' "+
                  "data-duration='"+obj.duration+"' "+
                  " class='suggestion-item'>"+
                    "<img class='suggestion-img' src='"+getImgFromID(obj.id)+"'>"+
                    "<span class='suggestion-info'>"+
                      "<div class='suggestion-title'>"+escapeQuotes(obj.title)+"</div>"+
                      "<span class='suggestion-uploader'>by "+escapeQuotes(obj.uploader)+"&nbsp;&nbsp;&nbsp;</span>"+
                      "<span class='suggestion-view'>"+obj.viewCount+" views</span>"+
                    "</span>"+
                "</li>"
                );
            });

            $(".suggestion-item").first().addClass("selected");
            $(".suggestion-item").hover(function() {
              $(this).addClass("selected");
            }, function() {
              $(this).removeClass("selected")
            });
            $("#startSongInputSuggestion li.suggestion-item").click(function() {
              openPlayingPage($(this));
            });
            $("#newSongInputSuggestion li.suggestion-item").click(function() {
              addSong2Playlist($(this));
            });
          }
          else
          {
            $(suggestionDiv).append("<li>No match found.</li>");
          }
        }
      });

    }

    function getFrameID(id){
      var elem = document.getElementById(id);
      if (elem) {
        if(/^iframe$/i.test(elem.tagName)) return id; //Frame, OK
        // else: Look for frame
        var elems = elem.getElementsByTagName("iframe");
        if (!elems.length) return null; //No iframe found, FAILURE
        for (var i=0; i<elems.length; i++) {
          if (/^https?:\/\/(?:www\.)?youtube(?:-nocookie)?\.com(\/|$)/i.test(elems[i].src)) break;
        }
        elem = elems[i]; //The only, or the best iFrame
        if (elem.id) return elem.id; //Existing ID, return it
        // else: Create a new ID
        do { //Keep postfixing `-frame` until the ID is unique
          id += "-frame";
        } while (document.getElementById(id));
        elem.id = id;
        return id;
      }
      // If no element, return null.
      return null;
    }

    // Define YT_ready function.
    var YT_ready = (function() {
      var onReady_funcs = [], api_isReady = false;
      /* @param func function     Function to execute on ready
       * @param func Boolean      If true, all qeued functions are executed
       * @param b_before Boolean  If true, the func will added to the first
                                   position in the queue*/
      return function(func, b_before) {
        if (func === true) {
          api_isReady = true;
          while (onReady_funcs.length) {
            // Removes the first func from the array, and execute func
            onReady_funcs.shift()();
          }
        } else if (typeof func == "function") {
            if (api_isReady) func();
            else onReady_funcs[b_before?"unshift":"push"](func); 
        }
      }
    })();

    function onYouTubePlayerAPIReady() {YT_ready(true)}

    YT_ready(function(){
      var frameID = getFrameID("player-frame");
      if (frameID) { //If the frame exists
        player = new YT.Player(frameID, {
          id: 'u1zgFlCw8Aw',
          events: {
            "onStateChange": videoStateChanged
          }
        });
        console.log("Player is ready " + player);
      }
    });

    function videoStateChanged(event) {
      if (event.data === 0) {
        temp = $(".playing");
        temp.removeClass("playing");
        temp.next().addClass("playing");
        $("body").scope().playNextSong(player);
      }
    }

    function addSong2Playlist(liObj) {
      $("#newSongInputSuggestion").addClass("hidden");
      $("#playlist").removeClass("hidden"); 
      $("body").scope().addSong2Playlist(liObj);      

      $("#newSongInput").val("");
      $("#newSongInputSuggestion").empty();
      
      // Re-bind click event to new play playlist item
      setupPlaylistItemEffect();
    }

    function setupPlaylistItemEffect() {         
      $(".playlist-item").click(function() {
        $(".playing").removeClass("playing");
        $(this).addClass("playing");
        $("body").scope().playSong(player, $(this).data('index'));
      });

      $(".playlist-item").hover(function() {
        $(this).addClass("selected");
        $(this).find(".remove-song-btn").show(100);
      }, function() {
        $(this).removeClass("selected");
        $(this).find(".remove-song-btn").hide(100);
      });
    }

    function openPlayingPage(libObj) {
      height = $("html").height()*0.85;
      $("html").css('background-image', 'none');
      $("#search-form").remove();
      $("#player-frame").removeClass("transparent");
      $("#player-frame").css("height", height);
      $("#user-control").removeClass("hidden");
      $("#user-control").css("height", height);
      $("body").addClass("stripesDarkBackground");
      $("#newSongInput").focus();
      setTimeout(function() {
        $("#user-control").trigger("mouseleave");
      }, 1000);
      $("#add-song-btn").click(function() {
        selectedSong = getSelectedItem("newSongInputSuggestion", "suggestion-item", "selected");
        addSong2Playlist(selectedSong);
      });
      $("body").scope().addSong2PlaylistAndPlay(player, libObj);
      $("#playlist .playlist-item").first().addClass("playing");
      setupPlaylistItemEffect();
    }

    function escapeQuotes(str) {
      return (str + '').replace('"', '&#34;').replace("'", '&#39;');
    }

    function callPlayer(frame_id, func, args) {
      if (window.jQuery && frame_id instanceof jQuery) frame_id = frame_id.get(0).id;
      var iframe = document.getElementById(frame_id);
      if (iframe && iframe.tagName.toUpperCase() != 'IFRAME') {
        iframe = iframe.getElementsByTagName('iframe')[0];
      }
      if (iframe) {
        // Frame exists, 
        iframe.contentWindow.postMessage(JSON.stringify({
            "event": "command",
            "func": func,
            "args": args || [],
            "id": frame_id
        }), "*");
      }
    }

  </script>
</body>
</html>